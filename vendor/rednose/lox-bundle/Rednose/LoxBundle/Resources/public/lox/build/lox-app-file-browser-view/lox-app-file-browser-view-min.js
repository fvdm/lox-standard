YUI.add("lox-app-file-browser-view",function(e,t){var n='<p class="text-center"><strong>Welcome to LocalBox</strong></p><p class="text-center">With LocalBox, it\'s safe and easy<br/>to store your files where and whenever<br/>you want.</p><p class="text-center"><a id="lox-upload-link" href="#">Upload</a> your files and share them with your colleagues.</p>',r="Download",i="Share folder",s="Share settings",o="Create link",u="Delete",a="Leave share",f="Rename",l="Move",c="Copy",h=[{title:a,icon:"share",id:"leave"},{title:u,icon:"remove-circle",id:"delete"},{title:f,icon:"edit",id:"rename"},{title:l,icon:"circle-arrow-right",id:"move"},{title:c,icon:"check",id:"copy"}],p=[{title:s,icon:"share",id:"share"},{title:u,icon:"remove-circle",id:"delete"},{title:f,icon:"edit",id:"rename"},{title:l,icon:"circle-arrow-right",id:"move"},{title:c,icon:"check",id:"copy"}],d=[{title:i,icon:"share",id:"share"},{title:u,icon:"remove-circle",id:"delete"},{title:f,icon:"edit",id:"rename"},{title:l,icon:"circle-arrow-right",id:"move"},{title:c,icon:"check",id:"copy"}],v=[{title:o,icon:"globe",id:"link"},{title:r,icon:"download",id:"download"},{title:u,icon:"remove-circle",id:"delete"},{title:f,icon:"edit",id:"rename"},{title:l,icon:"circle-arrow-right",id:"move"},{title:c,icon:"check",id:"copy"}],m="Create a new folder...",g="Name",y="Create",b="Cancel",w="Created",E="Folder successfully created.",S="Name",x="Size",T="Modified",N="Upload files",C="New folder";TEXT_MENU="Actions",e.Lox.ItemView=e.Base.create("itemView",e.View,[],{template:'<div class="rednose-lox-header"><div class="header-top"><div id="breadcrumb" class="pull-left"></div><form class="pull-right"><div class="btn-group"><button title="{titleUpload}" rel="tooltip" id="lox-upload-button" type="button" class="btn"><i class="icon-upload"></i></button><button title="{titleNewFolder}" rel="tooltip" id="lox-newfolder-button" type="button" class="btn"><i class="icon-folder-close"></i></button></div></form></div><div class="header-bottom"><table class="table"><thead><tr><th class="span4">{name}</th><th class="span2">{size}</th><th class="span2">{modified}</th></tr><thead></table><div class="details" style="display: none;"><div class="item-name pull-left"></div><div class="menu dropdown pull-right"><a href="#" class="dropdown-toggle" data-toggle="dropdown">{menu} <b class="caret"></b></a><ul class="dropdown-menu"></ul></div></div></div></div>',events:{"#lox-upload-link":{click:"_handleUpload"},"#lox-upload-button":{click:"_handleUpload"},"#lox-newfolder-button":{click:"_handleCreateFolder"}},initializer:function(){var t=this.get("container"),n=this.get("model");t.setHTML(e.Lang.sub(this.template,{name:S,size:x,modified:T,titleUpload:N,titleNewFolder:C,menu:TEXT_MENU})),t.one(".rednose-lox-header").plug(e.Plugin.Affix,{offset:{top:40}}),this.breadcrumbView=new e.Rednose.Breadcrumb({container:t.one("#breadcrumb"),path:n.get("path")}),this.breadcrumbView.addTarget(this),this.on("*:navigate",this._handleNavigate),this.after("selectionChange",this._afterSelectionChange,this);var r=t.one(".menu");r.on("click",function(e){e.stopImmediatePropagation()})},destructor:function(){this.breadcrumbView.destroy(),delete this.breadcrumbView},render:function(){return this.breadcrumbView.render(),this},_handleNavigate:function(e){var t=e.data;t&&this.fire("navigateItem",{path:t})},_handleUpload:function(e){e.preventDefault(),this.fire("upload")},_handleCreateFolder:function(){var t=new e.Rednose.Dialog,n=this.get("model").get("path"),r=this;t.prompt({title:m,text:g,confirm:y,cancel:b},function(i){e.io(YUI.Env.routing.operations_create_folder,{method:"POST",data:{path:n+"/"+i},on:{success:function(n,i){var s=e.JSON.parse(i.responseText),o=new e.Lox.ItemModel;o.setAttrs(o.parse(s)),t.destroy(),r.fire("itemAdded",{data:o}),e.Rednose.Notifier.notify({title:w,text:E,type:"success"})},failure:function(n,r){var i=r.responseText&&e.JSON.parse(r.responseText);i.error&&t.set("error",{message:i.error})}}})})},_afterSelectionChange:function(t){var n=t.newVal,r=this.get("container");if(n!==null){var i=r.one(".menu"),s=new e.Rednose.Navbar,o=null;r.one(".item-name").setContent(n.get("title")),i.one("ul").empty(),s.addTarget(this),n.get("isDir")?n.get("isShare")?o=h:n.get("isShared")?o=p:o=d:o=v,s.createDropdown(i,o),r.one(".table").hide(),r.one(".details").show()}else r.one(".details").hide(),r.one(".table").show()}},{ATTRS:{selection:{value:null}}});var k="Delete item '{item}'?",L="The item will be removed. Are you sure you want to delete it?",A="Error",O="Deleted",M="Item successfully deleted.",_="Rename item '{item}'?",D="Name",P="Renamed",H="Item successfully renamed.",B="This folder is empty",j="icon-file-16-",F="file-title",I="url",q="--",R="--";e.Lox.ItemListView=e.Base.create("itemListView",e.View,[],{template:'<div class="rednose-lox-body"><div class="file-table"/></div>',events:{".rednose-datatable-data tr a":{click:"_clickItem"},".rednose-datatable-data tr":{contextmenu:"_handleRowContext"}},initializer:function(){this.get("container").setHTML(this.template),this._initDatatable()},destructor:function(){this._dataTable.destroy(),this._dataTable=null},render:function(){var e=this.get("container"),t=this._dataTable;return t.render(e.one(".file-table")),this},_initDatatable:function(){var t=this.get("modelList"),n;n=this._dataTable=(new e.Rednose.DataTable({columns:[{key:"title",nodeFormatter:function(t){t.cell.addClass("span4"),t.cell.set("innerHTML",e.Lang.sub('<div class="{classTitle}"><i class="{iconClass}"></i> <a href="#" class="{classUrl}">{title}</a></div>',{classTitle:F,iconClass:j+t.data.icon,classUrl:I,title:t.data.title}))},sortable:!0},{key:"size",nodeFormatter:function(t){t.cell.addClass("span2"),t.cell.set("text",t.data.isDir?q:e.Rednose.Formatter.size(t.data.size))}},{key:"dateFormatted",nodeFormatter:function(e){e.cell.addClass("span2"),e.cell.set("text",e.data.isDir===!0?R:e.data.dateFormatted)}}],sortBy:"title",data:t})).plug(e.Rednose.DataTableSelectPlugin),n.addTarget
(this)},_clickItem:function(e){e.preventDefault(),e.stopImmediatePropagation();var t=this.get("modelList"),n=t.getByClientId(e.currentTarget.ancestor("tr").getAttribute("data-yui3-record"));n&&(n.get("isDir")===!0?this.fire("navigateItem",{path:n.get("path")}):this.fire("showItemDetail",{model:n}))},_handleRowContext:function(t){t.preventDefault();var n=t.currentTarget,r=n.getAttribute("data-yui3-record"),i=this.get("modelList").getByClientId(r),s=t.pageX,o=t.pageY,u;i.get("isDir")?i.get("isShare")?u=h:i.get("isShared")?u=p:u=d:u=v;if(n.contextMenu)return!1;n.plug(e.Rednose.ContextMenu,{content:u,data:i,bubbleTarget:this}),n.contextMenu.open(s,o)}});var U=e.Base.create("fileBrowserView",e.View,[],{initializer:function(){this._fileBrowserViewEvents||(this._fileBrowserViewEvents=[]);var t=this.get("model"),n=this.get("modelList");this.itemView=new e.Lox.ItemView({model:t}),this.itemListView=new e.Lox.ItemListView({modelList:n}),this.itemView.addTarget(this),this.itemListView.addTarget(this),this._fileBrowserViewEvents.push(this.on({"*:link":this._handleCreateLink,"*:download":this._handleDownload,"*:delete":this._handleDelete,"*:rename":this._handleRename,"*:leave":this._prepEvent,"*:share":this._prepEvent,"*:move":this._prepEvent,"*:copy":this._prepEvent,"*:itemAdded":this._handleItemAdded,"*:select":this._handleSelect}),n.after(["add","reset","remove"],this._checkCount,this))},destructor:function(){(new e.EventHandle(this._fileBrowserViewEvents)).detach(),this.itemView.destroy(),this.itemListView.destroy(),delete this.itemView,delete this.itemListView},render:function(){var t=this.get("container"),n=e.one(e.config.doc.createDocumentFragment());return n.append(this.itemView.render().get("container")),n.append(this.itemListView.render().get("container")),t.setHTML(n),this._checkCount(),this},_checkCount:function(){var t=this.get("container"),r=this.get("modelList"),i=this.get("model");if(r.get("items").length===0){var s=e.Lang.sub("<h4>{empty}</h4>",{empty:B});i.get("path")==="/"&&(s=n),t.one(".table").append('<tbody class="table-message"><tr><td colspan="3">'+s+"</td>"+"</tr>"+"</tbody>")}else t.all("tbody.table-message").remove()},_handleSelect:function(e){var t=e.model;this.itemView.set("selection",t)},_handleItemAdded:function(e){var t=e.data;this.itemListView.get("modelList").add(t)},_handleCreateLink:function(t){var n=t.data||this.itemView.get("selection");n&&e.config.win.open(YUI.Env.routing.link_create+n.get("path"),"_blank")},_handleDownload:function(t){var n=t.data||this.itemView.get("selection");n&&(e.config.win.location=YUI.Env.routing.item+n.get("path")+"?download=1")},_handleDelete:function(t){var n=t.data||this.itemView.get("selection");n&&e.Rednose.Dialog.confirm({title:e.Lang.sub(k,{item:n.get("title")}),text:L,confirm:u,type:"danger"},function(){n.destroy({remove:!0},function(t){t?e.Rednose.Notifier.notify({title:A,text:t.error||"",type:"error"}):e.Rednose.Notifier.notify({title:O,text:M,type:"success"})})})},_handleRename:function(t){var n=t.data||this.itemView.get("selection");dialog=new e.Rednose.Dialog,self=this,dialog.prompt({title:e.Lang.sub(_,{item:n.get("title")}),text:D,confirm:f,value:n.get("title")},function(t){var r=n.get("path"),i=n.getBase()+"/"+t;e.io(YUI.Env.routing.operations_move,{method:"POST",data:{from_path:r,to_path:i},on:{success:function(){dialog.destroy(),self.fire("reload"),e.Rednose.Notifier.notify({title:P,text:H,type:"success"})},failure:function(t,n){var r=n.responseText&&e.JSON.parse(n.responseText);r.error&&dialog.set("error",{message:r.error})}}})})},_prepEvent:function(e){e.data||(e.data=this.itemView.get("selection"))}});e.namespace("Lox.App").FileBrowserView=U},"@VERSION@",{requires:["datatable-select","gallery-affix","lox-app-file-movecopy-view","lox-app-item-model","rednose-app","rednose-breadcrumb","rednose-contextmenu","rednose-datatable-select","rednose-dialog","rednose-formatter","rednose-navbar","rednose-notifier"]});
